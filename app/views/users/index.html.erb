<%= javascript_pack_tag 'users' %>
<div class="sans-head mx-4">
      <div class="row no-gutters justify-content-center">
        <div class="col-12 col-sm-8 col-md-4 border-right pr-2">
          <% if user_signed_in? %>
            <p class="tablePrint mt-3">Connecté en tant que :<span class="text-muted"> <%= current_user.email %></span></p>
          <% end %>
          <h6 class="tablePrint my-2">Visiteurs non connectés: <span class="text-muted"><%= @users.where(is_signed_in: false).count%></span></h6>
          <h6 class="tablePrint my-2">Visiteurs connectés: <span class="text-muted"><%= @users.where(is_signed_in: true, current_sign_in_at: Time.now).count%></span></h6>
          <% @users.each do |user| %>
              <%if user.current_sign_in_at%>
              <%if user.current_sign_in_at == Time.now%>
              <%if user.is_super_admin == false%>
                  <%if user.total_online_time != nil%>
                    <div class="pb-3">
                      <div class="active-user bg-white p-2 rounded-0 border-bottom" data-id="<%= user.id %>">
                        <!-- <span class="online-icon d-inline-block bg-success"></span> -->
                        <span class="tablePrint"><%= user.email %></span>
                        <div class="mt-2">
                          <span class="text-muted mt-3">Aujourd'hui <%= user.current_sign_in_at.strftime("à %I:%M %p")%></span><br>
                          <span class="text-muted"> Durée de connexion : <%= Time.at((user.total_online_time) * 60).utc.strftime("%H:%M:%S")%></span>
                        </div>
                      </div>        
                    </div>
                  <%end%>
                  <%end%>
                  <%end%>                
              <% end %>
          <% end %>
        
          <p class="tablePrint mb-2">Les historiques de connexions selon la date ci - dessous</p>
          <%= form_tag(users_index_path, :method => "get", class: 'gQwHOW row no-gutters align-items-center') do %>
          <div class="col-10 pr-2">
            <input type="date" name="loggin_date" class="form-control" required="true" oninvalid="this.setCustomValidity('Choisissez une date')" oninput="this.setCustomValidity('')">
          </div>
          <div class="col-2">
            <%= submit_tag "Voir", :class => "sc-eerKOB cfnPHQ ", :name => nil%>
          </div>
          <%end%>
     
      </div>
        <%if @date%>
          <div class="col-12 col-sm-10 col-md-8">
              <%@visits = Visit.where('Date(created_at) = ?', @date).where.not(user_id: 1).page(params[:page]).per(9)%>
                <%if @visits%>
                  <%if @visits.count != 0%>

                    <h4 class="text-center text-muted mb-4 h5-historique">Historiques de connexions le <%= params[:loggin_date].to_date %></h4>
                  <table class="table table-striped table-xl">
                    <thead class="text-muted font-weight-bolder">
                      <tr>
                        <th scope="col">Email</th>
                        <th scope="col"><p class="text-center">Organisme</p></th>
                        <th scope="col">Fonction</th>
                        <th scope="col">Téléphone</th>
                        <th scope="col">Heure de connexion</th>
                        <th scope="col">Durée de connexion</th>
                      </tr>
                    </thead>
                    <tbody>
                    <%@visits.each do |v|%>
                    <%if v.user_total_online_time != nil%>
                      <tr>
                        <th scope="col"><span class="text-color-secondary"><%= v.user_email%></span></th>
                        <th scope="col">
                          <%if v.user_organisme != nil%>
                            <p class="text-center"><%= v.user_organisme%></p>
                          <%end%>
                        </th>
                        <th scope="col">
                          <%if v.user_fonction != nil%>
                            <%= v.user_fonction%>
                          <%end%>
                        </th>
                        <th scope="col">
                          <%if v.user_phone != nil%>
                            <%= v.user_phone%>
                          <%end%>
                        </th>
                        <th scope="col"><%= v.created_at.to_s(:time)%></th>
                        <th scope="col">
                          <%if v.user_total_online_time != nil && Time.at(((v.user_total_online_time)) * 60).utc.strftime("%H:%M:%S") <= "08:00:00"%>
                            <%= Time.at(((v.user_total_online_time)) * 60).utc.strftime("%H:%M:%S")%>
                          <%else%>
                            08:00:00  
                          <%end%>
                        </th>
                      </tr>
                    <%end%>
                    <%end%>
                    </tbody>
                  </table>
                  <div class="date-projet-small">
                    <%@visits.each do |v|%>
                      <div class="mt-3 p-3 bg-white border-bottom">
                        <%if v.user_total_online_time != nil%>
                          <p><span class="tablePrint">Email : </span><span><%= v.user_email%></span></p>
                          <%if v.user_organisme != nil%>
                            <p><span class="tablePrint">Organisme : </span><span><%= v.user_organisme%></span></p>
                          <%end%>
                          <%if v.user_fonction != nil%>
                            <p><span class="tablePrint">Fonction : </span><span><%= v.user_fonction%></span></p>
                          <%end%>
                          <%if v.user_phone != nil%>
                            <p><span class="tablePrint">Téléphone : </span><span><%= v.user_phone%></span></p>
                          <%end%>
                          <p><span class="tablePrint">Heure de connexion : </span><span><%= v.created_at.to_s(:time)%></span></p>
                          <p><span class="tablePrint">Durée de connexion :</span>
                          <span>
                            <%if v.user_total_online_time != nil && Time.at(((v.user_total_online_time)) * 60).utc.strftime("%H:%M:%S") <= "08:00:00"%>
                               <%= Time.at(((v.user_total_online_time)) * 60).utc.strftime("%H:%M:%S")%>
                            <%else%>
                               00:00:00  
                            <%end%>
                          </span>
                        </p>
                        <%end%>
                      </div>
                    <%end%>
                  </div>
                  <div class="text-center my-3">
                    <%= paginate @visits %>
                  </div>
                <%else%>
                  <p class="text-center text-muted mt-5">Aucun visiteur connecté</p>  
                  <%end%>
              <%end%>
          </div>
          <div class="date-projet-small">
             
          </div>
        <%end%>
      </div>
</div>