<script>

  //FIliere et Forme d'appui par secteur
  function checkSecteur(x) {
    var filAsso = true
    var formAsso = true
    var secteurChoisi = false;
        <%Secteur.all.each do |s|%>
        var s<%= s.id %> = document.getElementById('s<%= s.id %>')

        // Si un sécteur est coché, il y a donc un ou plusieurs sécteurs choisi
        if (s<%= s.id %>.checked == true) { 
          secteurChoisi = true;
          <%if s.secteur_filieres.count > 0%>
            filAsso = false;
          <%end%>
          <%if s.formesecteurs.count > 0%>
            formAsso = false;
          <%end%>

        }

        // Si l'utilisateur click le sécteur 'x':
            if(x == <%= s.id%>){
              // Chercher toutes les filières qui correspondent au secteur X
                <%s.secteur_filieres.each do |sf|%>
                if (document.getElementById('fil'+<%= sf.filiere.id%>) != null) {
                    var f = document.getElementById('fil'+<%= sf.filiere.id%>);
                }
                    if (document.getElementById('idfil'+<%= sf.id%>) != null) {
                      var idfil = document.getElementById('idfil'+<%= sf.id%>);
                    }
                    // si le secteur X est décoché, décocher et cacher toutes les filières qui correspondent à X

                      if(f.style.display == "block"){
                          if (idfil != null) {
                          f.style.display = "none";
                            idfil.checked = false;
                          }
                      // si le secteur X est coché, afficher toutes les filières qui correspondent à X
                      }else{
                          f.style.display = "block";
                      }
                <%end%>
            }
        <%end%>
          var filexist = document.getElementById('filexist');
          var filnotexist = document.getElementById('filnotexist');
        if(filAsso == true){
          document.getElementById('nofil').innerHTML = "Aucune filière assocciée";
          filexist.style.display = "none";
          filnotexist.style.display = "block";
        }else{
          filexist.style.display = "block";
          filnotexist.style.display = "none";
        }

        // Cacher d'abord tout les filières
        <% Filiere.all.each do |fili| %>
          document.getElementById('fil'+<%= fili.id%>).style.display = "none";
        <% end %>

      // Afficher tous les filières qui correspondent aux sécteurs cochés
      <%Filiere.order(:title).all.each do |fili|%>
        <% fili.secteur_filieres.each do |sf| %>
          var secteur_de_fili = document.getElementById('s<%= sf.secteur.id %>');
          if (secteur_de_fili.checked == true ) {
            document.getElementById('fil'+<%= fili.id%>).style.display = "block";
          }
        <% end %>
      <% end %>

      // décoché les filières si les sécteurs correspondants sont décochés
      <%Filiere.order(:title).all.each do |fili|%>
        var filCheck<%= fili.id %> = document.getElementById('filCheck<%= fili.id %>');
        var unSecteurCoche = false;
        <% fili.secteur_filieres.all.each do |sf| %>
          if (document.getElementById('s<%= sf.secteur.id %>').checked == true) {
            unSecteurCoche = true;
          }
        <% end %>
        if (unSecteurCoche == false) {
          filCheck<%= fili.id %>.checked = false;
        }
      <% end %>


    //Forme d'appui par secteur


        <%Formesecteur.all.each do |fs|%>
        var fs = document.getElementById('forme'+<%= fs.forme.id%>);
        fs.style.display = "none";
      <%end%>

        <%Secteur.all.each do |s|%>
          // Si l'utilisateur click le sécteur 'x':
            if(x == <%= s.id%>){
              // Chercher toutes les formes d'appui qui correspondent au secteur X
                <%s.formesecteurs.each do |fs|%>
                    var fs = document.getElementById('form'+<%= fs.forme.id%>);
                    if (document.getElementById('idform'+<%= fs.id%>) != null) {
                      var idform = document.getElementById('idform'+<%= fs.id%>);
                    }
                    // si le secteur X est décoché, décocher et cacher toutes les formes d'appui qui correspondent à X
                    if(fs.style.display == "block"){
                        if (idform != null) {
                          fs.style.display = "none";
                          idform.checked = false;
                        }
                    // si le secteur X est coché, afficher toutes les formes d'appui qui correspondent à X
                    }else{
                        fs.style.display = "block";
                    }
                <%end%>
            }
        <%end%>

          var formexist = document.getElementById('formexist');
          var formnotexist = document.getElementById('formnotexist');
        if(formAsso == true){
          document.getElementById('noform').innerHTML = "Aucune forme d'appui assocciée";
          formexist.style.display = "none";
          formnotexist.style.display = "block";
        }else{
          formexist.style.display = "block";
          formnotexist.style.display = "none";
        }

        // Cacher d'abord tout les formes d'appui
        <% Forme.all.each do |f| %>
          document.getElementById('form'+<%= f.id%>).style.display = "none";
        <% end %>

      // Afficher tous les formes d'appui qui correspondent aux sécteurs cochés
      <%Forme.order(:title).all.each do |form|%>
        <% form.formesecteurs.each do |fs| %>
          var secteur_de_form = document.getElementById('s<%= fs.secteur.id %>');
          if (secteur_de_form.checked == true ) {
            document.getElementById('form'+<%= form.id%>).style.display = "block";
          }
        <% end %>
      <% end %>

      // décoché les formes d'apui si les sécteurs correspondants sont décochés
      <%Forme.order(:title).all.each do |form|%>
        var formCheck<%= form.id %> = document.getElementById('formCheck<%= form.id %>');
        var unSecteurCoche = false;
        <% form.formesecteurs.all.each do |fs| %>
          if (document.getElementById('s<%= fs.secteur.id %>').checked == true ) {
            unSecteurCoche = true;
          }
        <% end %>
        if (unSecteurCoche == false) {
          formCheck<%= form.id %>.checked = false;
        }
      <% end %>


        // Si un ou plusieurs secteur(s) sont cochés
        if (secteurChoisi == true) {
          // ne pas afficher toutes les filières
          <%Filiere.order(:title).all.each do |fili|%>
          var fl = document.getElementById('fl'+<%= fili.id%>);
          fl.style.display = "none";
          <%end%>

          // ne pas afficher toutes les formes
        <%Forme.order(:title).all.each do |form|%>
        var forme = document.getElementById('forme'+<%= form.id%>);
          forme.style.display = "none";
        <%end%>

      // Si aucun sécteur n'est coché
        } else{
          // Affiche toutes les filieres
          <%Filiere.order(:title).all.each do |fili|%>
          var fl = document.getElementById('fl'+<%= fili.id%>);
          var fil = document.getElementById('fil'+<%= fili.id%>);
          fl.style.display = "block";
          fil.style.display = "none";
        <%end%>

        // Afficher tous les formes
        <%Forme.order(:title).all.each do |form|%>
        var forme = document.getElementById('forme'+<%= form.id%>);
        var form = document.getElementById('form'+<%= form.id%>);
          forme.style.display = "block";
          form.style.display = "none";
        <%end%>
          filexist.style.display = "block";
          filnotexist.style.display = "none";   
          formexist.style.display = "block";
          formnotexist.style.display = "none";
        }

  }

</script>